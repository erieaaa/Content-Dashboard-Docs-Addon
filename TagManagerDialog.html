<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
      :root { --primary-color: #4a86e8; --border-color: #ddd; }
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; font-size: 14px; }
      h3 { margin-top: 0; }
      p.subtitle { font-size: 13px; color: #666; margin-top: -10px; margin-bottom: 20px; }
      ul { list-style-type: none; margin: 0; padding: 0; }
      li { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px; }
      .tag-display { display: flex; align-items: center; gap: 8px; flex-grow: 1; }
      .tag-color-swatch { width: 18px; height: 18px; border-radius: 4px; border: 1px solid #ccc; flex-shrink: 0; }
      .tag-name { font-weight: bold; }
      .actions { display: flex; gap: 8px; }
      button { padding: 6px 10px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; }
      .button-primary { background-color: var(--primary-color); }
      .button-secondary { background-color: #666; }
      .button-danger { background-color: #d93025; }
      button:disabled { background-color: #ccc !important; cursor: not-allowed; }
      input[type="text"], input[type="color"] { padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; }
      input[type="color"] { height: 32px; padding: 4px; }
      .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h3>Custom Tag Library</h3>
    <p class="subtitle">Edit, delete, or create new custom tags. Core tags (intro, body, conclusion) cannot be modified.</p>
    
    <div id="loader" style="display: none;"><div class="loader"></div></div>
    <ul id="tag-list"></ul>
    
    <!-- Section for creating a new tag -->
    <div class="section" style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
      <h4>Create New Tag</h4>
      <li id="create-new-tag-li">
        <div class="tag-display">
          <input type="color" id="newTagColor" value="#a2c4c9">
          <input type="text" id="newTagName" placeholder="new-tag-name" style="flex-grow: 1;">
        </div>
        <div class="actions">
          <button class="button-primary" onclick="handleCreateTag()">Create</button>
        </div>
      </li>
    </div>

    <script>
      let ALL_TAGS = [];
      const CORE_TAG_NAMES = ['intro', 'body', 'conclusion'];

      document.addEventListener('DOMContentLoaded', loadTags);

      function setLoading(isLoading) {
        document.getElementById('loader').style.display = isLoading ? 'block' : 'none';
        document.getElementById('tag-list').style.display = isLoading ? 'none' : 'block';
      }

      function loadTags() {
        setLoading(true);
        google.script.run.withSuccessHandler(onTagsLoaded).withFailureHandler(onFailure).getAllTags();
      }

      function onTagsLoaded(tags) {
        ALL_TAGS = tags;
        const list = document.getElementById('tag-list');
        list.innerHTML = '';
        
        tags.forEach(tag => {
          const isCore = CORE_TAG_NAMES.includes(tag.name);
          const li = document.createElement('li');
          li.id = `tag-${tag.name}`;
          
          li.innerHTML = `
            <div class="tag-display">
              <div class="tag-color-swatch" style="background-color: ${tag.color};"></div>
              <span class="tag-name">${tag.name}</span>
            </div>
            <div class="actions">
              ${isCore ? '<span style="color: #999; font-size: 12px;">Core Tag</span>' : 
                         `<button class="button-secondary" onclick="toggleEditMode('${tag.name}', true)">Edit</button>
                          <button class="button-danger" onclick="handleDeleteTag('${tag.name}')">Delete</button>`}
            </div>
          `;
          list.appendChild(li);
        });
        setLoading(false);
      }

      function toggleEditMode(tagName, isEditing) {
        const li = document.getElementById(`tag-${tagName}`);
        const tag = ALL_TAGS.find(t => t.name === tagName);
        
        if (isEditing) {
          li.innerHTML = `
            <div class="tag-display">
              <input type="color" id="edit-color-${tagName}" value="${tag.color}">
              <input type="text" id="edit-name-${tagName}" value="${tag.name}" style="flex-grow: 1;">
            </div>
            <div class="actions">
              <button class="button-primary" onclick="handleSaveTag('${tagName}')">Save</button>
              <button class="button-secondary" onclick="toggleEditMode('${tagName}', false)">Cancel</button>
            </div>
          `;
        } else {
          // Revert to original display
          onTagsLoaded(ALL_TAGS);
        }
      }

      function handleSaveTag(oldName) {
        setLoading(true);
        const newName = document.getElementById(`edit-name-${oldName}`).value;
        const newColor = document.getElementById(`edit-color-${oldName}`).value;
        const newTagObject = { name: newName, color: newColor };
        google.script.run.withSuccessHandler(onActionComplete).withFailureHandler(onFailure).updateTag(oldName, newTagObject);
      }

      function handleDeleteTag(tagName) {
        if (confirm(`Are you sure you want to delete the tag "${tagName}"? All paragraphs using this tag will become untagged.`)) {
          setLoading(true);
          google.script.run.withSuccessHandler(onActionComplete).withFailureHandler(onFailure).deleteTag(tagName);
        }
      }

      function handleCreateTag() {
        setLoading(true);
        const nameInput = document.getElementById('newTagName');
        const colorInput = document.getElementById('newTagColor');
        const tagObject = { name: nameInput.value, color: colorInput.value, position: 'end' }; // Position is 'end' for simplicity here
        google.script.run.withSuccessHandler(onActionComplete).withFailureHandler(onFailure).createNewTag(tagObject);
        nameInput.value = ''; // Clear input on success
      }

      function onActionComplete(result) {
        if (result.success) {
          loadTags(); // Reload the list to show changes
        } else {
          alert('Error: ' + result.message);
          setLoading(false);
        }
      }

      function onFailure(error) {
        setLoading(false);
        alert('An unexpected error occurred: ' + error.message);
      }

    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
      :root { --primary-color: #4a86e8; --primary-hover: #3c72c4; --border-color: #ddd; }
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; }
      h3 { margin-top: 0; }
      .form-group { margin-bottom: 15px; }
      label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
      input[type="text"], input[type="color"] {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-sizing: border-box;
      }
      input[type="color"] { height: 40px; padding: 4px; }
      .dialog-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
      button { padding: 8px 12px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; transition: background-color 0.2s ease; }
      button:disabled { background-color: #ccc !important; cursor: not-allowed; }
      .button-primary { background-color: var(--primary-color); }
      .button-secondary { background-color: #666; }
      #error-message { color: #d93025; font-size: 12px; margin-top: 5px; display: none; }
    </style>
</head>
<body>
    <h3>Create a New Custom Tag</h3>

    <div class="form-group">
      <label for="newTagName">Tag Name</label>
      <input type="text" id="newTagName" placeholder="e.g., case-study">
    </div>

    <div class="form-group">
      <label for="newTagColor">Tag Color</label>
      <input type="color" id="newTagColor" value="#a2c4c9">
    </div>
    
    <p id="error-message"></p>

    <div class="dialog-footer">
      <button class="button-secondary" onclick="google.script.host.close()">Cancel</button>
      <button id="createBtn" class="button-primary" onclick="handleCreateTag()">Create Tag</button>
    </div>

    <script>
      let usedColors = [];

      document.addEventListener('DOMContentLoaded', () => {
        // Fetch the colors that are already in use
        google.script.run.withSuccessHandler(colors => {
          usedColors = colors.map(c => c.toLowerCase());
          // Optional: Set a default color that is not already in use
          let initialColor = '#a2c4c9';
          while(usedColors.includes(initialColor)) {
              initialColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
          }
          document.getElementById('newTagColor').value = initialColor;
        }).getUsedColors();

        document.getElementById('newTagColor').addEventListener('input', validateColor);
        document.getElementById('newTagName').addEventListener('input', () => {
             document.getElementById('error-message').style.display = 'none';
        });
      });
      
      function validateColor(event) {
        const selectedColor = event.target.value.toLowerCase();
        const errorEl = document.getElementById('error-message');
        const createBtn = document.getElementById('createBtn');

        if (usedColors.includes(selectedColor)) {
          errorEl.textContent = 'This color is already in use by another tag. Please choose a different color.';
          errorEl.style.display = 'block';
          createBtn.disabled = true;
        } else {
          errorEl.style.display = 'none';
          createBtn.disabled = false;
        }
      }

      function handleCreateTag() {
        const createBtn = document.getElementById('createBtn');
        const tagNameInput = document.getElementById('newTagName');
        const tagColorInput = document.getElementById('newTagColor');
        const errorEl = document.getElementById('error-message');

        const tag = {
          name: tagNameInput.value,
          color: tagColorInput.value
        };

        if (!tag.name || !tag.name.trim()) {
           errorEl.textContent = 'Tag name cannot be empty.';
           errorEl.style.display = 'block';
           return;
        }
        
        createBtn.disabled = true;
        createBtn.textContent = 'Creating...';

        google.script.run
          .withSuccessHandler(response => {
            if (response.success) {
              google.script.host.close();
            } else {
              errorEl.textContent = response.message;
              errorEl.style.display = 'block';
              createBtn.disabled = false;
              createBtn.textContent = 'Create Tag';
            }
          })
          .withFailureHandler(err => {
            errorEl.textContent = 'An unexpected error occurred: ' + err.message;
            errorEl.style.display = 'block';
            createBtn.disabled = false;
            createBtn.textContent = 'Create Tag';
          })
          .createNewTag(tag);
      }
    </script>
</body>
</html>